<!DOCTYPE html>
<html lang="en" data-admin-hash="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure File Backup Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
    :root { --primary:#4361ee; --secondary:#3a0ca3; --accent:#7209b7; --light:#f8f9fa; --dark:#212529; --success:#4cc9f0; --danger:#e63946; --warning:#f72585; --gray:#6c757d; --border-radius:12px; --box-shadow:0 10px 25px rgba(0,0,0,.1); --transition:all .3s ease }
    body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; color:var(--dark); line-height:1.6; touch-action:manipulation }
    .container { width:100%; max-width:1200px; background-color:rgba(255,255,255,.95); border-radius:var(--border-radius); box-shadow:var(--box-shadow); overflow:hidden; min-height:80vh }
    .welcome-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; text-align:center; min-height:60vh }
    .welcome-screen h1 { color:var(--primary); margin-bottom:20px; font-size:2.5rem }
    .welcome-screen p { color:var(--gray); margin-bottom:30px; max-width:600px; font-size:18px }
    .auth-container { background:#fff; border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); width:100%; max-width:450px; margin:0 auto }
    .auth-tabs { display:flex; margin-bottom:25px; border-bottom:2px solid #eee }
    .auth-tab { flex:1; padding:15px; text-align:center; cursor:pointer; font-weight:600; color:var(--gray); transition:var(--transition); font-size:18px }
    .auth-tab.active { color:var(--primary); border-bottom:3px solid var(--primary) }
    .auth-form { display:none }
    .auth-form.active { display:block }
    .input-group { margin-bottom:20px; position:relative }
    .input-group label { display:block; margin-bottom:8px; color:var(--dark); font-weight:bold; text-align:left }
    .input-group input { width:100%; padding:16px; border:2px solid #ddd; border-radius:var(--border-radius); font-size:16px; transition:var(--transition) }
    .input-group input:focus { border-color:var(--primary); outline:none }
    .password-toggle { position:absolute; right:15px; top:45px; cursor:pointer; color:var(--gray); font-size:18px }
    .btn { padding:16px 30px; border:none; border-radius:50px; cursor:pointer; font-weight:600; transition:var(--transition); display:flex; align-items:center; justify-content:center; gap:10px; font-size:18px; width:100% }
    .btn-primary { background:linear-gradient(to right,var(--primary),var(--secondary)); color:#fff }
    .btn-primary:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.2) }
    .btn-outline { background:transparent; border:2px solid var(--primary); color:var(--primary) }
    .btn-outline:hover { background:var(--primary); color:#fff }
    .app-content { display:none }
    header { background:linear-gradient(to right,var(--primary),var(--secondary)); color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; position:relative }
    .logo { font-size:24px; font-weight:bold; display:flex; align-items:center }
    .logo i { margin-right:10px; font-size:28px }
    .user-controls { display:flex; align-items:center; gap:15px }
    .admin-indicator, .client-indicator { padding:8px 16px; border-radius:50px; font-size:14px; display:none }
    .admin-indicator { background-color:var(--accent); color:#fff }
    .client-indicator { background-color:var(--success); color:#fff }
    .main-content { padding:40px; display:flex; flex-direction:column; align-items:center }
    h1 { color:var(--primary); margin-bottom:20px; text-align:center; font-size:2.5rem }
    .description { text-align:center; margin-bottom:30px; color:var(--gray); max-width:700px; line-height:1.6; font-size:18px }
    .upload-container { width:100%; max-width:800px; background:#fff; border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); margin-bottom:30px }
    .drop-area { border:3px dashed var(--primary); border-radius:var(--border-radius); padding:40px 20px; text-align:center; cursor:pointer; transition:var(--transition); margin-bottom:20px }
    .drop-area:hover, .drop-area:active { background-color:#f0f7ff; transform:scale(1.01) }
    .drop-area i { font-size:60px; color:var(--primary); margin-bottom:15px }
    .drop-area p { color:var(--gray); margin:10px 0; font-size:18px }
    .file-input { display:none }
    .browse-btn { background:linear-gradient(to right,var(--primary),var(--secondary)); color:#fff; border:none; padding:14px 32px; border-radius:50px; cursor:pointer; font-weight:bold; margin-top:10px; transition:var(--transition); font-size:18px }
    .browse-btn:hover, .browse-btn:active { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.2) }
    .progress-container { width:100%; height:12px; background:#f0f0f0; border-radius:10px; margin:20px 0; overflow:hidden; display:none }
    .progress-bar { height:100%; background:linear-gradient(to right,var(--primary),var(--secondary)); width:0%; transition:width .4s ease }
    .status-message { text-align:center; margin:15px 0; font-weight:bold; color:var(--primary); font-size:16px }
    .panel { display:none; width:100%; margin-top:40px }
    .panel h2 { color:var(--primary); margin-bottom:20px; text-align:center; font-size:2rem }
    .stats-container { display:flex; justify-content:space-around; flex-wrap:wrap; gap:20px; margin-bottom:30px }
    .stat-card { background:#fff; border-radius:var(--border-radius); padding:20px; min-width:200px; text-align:center; box-shadow:var(--box-shadow) }
    .stat-card i { font-size:30px; color:var(--primary); margin-bottom:10px }
    .stat-card .number { font-size:28px; font-weight:bold; color:var(--secondary) }
    .stat-card .label { color:var(--gray); font-size:14px }
    .tabs { display:flex; margin-bottom:20px; border-bottom:2px solid #eee }
    .tab { padding:12px 24px; cursor:pointer; font-weight:600; color:var(--gray); transition:var(--transition) }
    .tab.active { color:var(--primary); border-bottom:3px solid var(--primary) }
    .files-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:25px; margin-top:20px }
    .file-card { background:#fff; border-radius:var(--border-radius); overflow:hidden; box-shadow:var(--box-shadow); transition:var(--transition) }
    .file-card:hover { transform:translateY(-5px) }
    .file-preview { height:160px; background:linear-gradient(45deg,#f0f7ff,#e2e9ff); display:flex; justify-content:center; align-items:center }
    .file-preview i { font-size:50px; color:var(--primary) }
    .file-info { padding:20px }
    .file-name { font-weight:bold; margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .file-meta { display:flex; justify-content:space-between; color:var(--gray); font-size:14px }
    .file-actions { display:flex; justify-content:space-between; margin-top:15px }
    .action-btn { padding:10px 16px; border:none; border-radius:5px; cursor:pointer; font-size:14px; transition:var(--transition) }
    .download-btn { background-color:var(--success); color:#fff }
    .delete-btn { background-color:var(--danger); color:#fff }
    footer { text-align:center; padding:25px; color:var(--gray); background-color:#f8f9fa; font-size:16px }
    .notification { position:fixed; top:20px; right:20px; padding:15px 25px; border-radius:5px; color:#fff; font-weight:bold; z-index:1100; opacity:0; transform:translateY(-20px); transition:opacity .3s, transform .3s; max-width:350px }
    .notification.success { background-color:var(--success) }
    .notification.error { background-color:var(--danger) }
    .notification.show { opacity:1; transform:translateY(0) }
    .client-id-display { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--primary); color:#fff; padding:30px 50px; border-radius:15px; font-size:28px; font-weight:bold; z-index:2000; box-shadow:0 15px 40px rgba(0,0,0,.3); text-align:center; display:none }
    .client-id-display .id-value { font-size:32px; margin:15px 0; color:var(--success); background:rgba(255,255,255,.1); padding:15px; border-radius:8px; font-family:monospace }
    @media (max-width:768px){ .container{min-height:90vh} .welcome-screen{padding:20px} .auth-container{padding:20px} .main-content{padding:20px} .files-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))} .stats-container{flex-direction:column; align-items:center} h1{font-size:2rem} .client-id-display{width:90%; padding:20px; font-size:22px} .client-id-display .id-value{font-size:24px} .user-controls{flex-direction:column; gap:10px} header{flex-direction:column; gap:15px} }
    .loader { display:inline-block; width:80px; height:80px; margin:20px 0 }
    .loader:after { content:" "; display:block; width:64px; height:64px; margin:8px; border-radius:50%; border:6px solid var(--primary); border-color:var(--primary) transparent var(--primary) transparent; animation:loader 1.2s linear infinite }
    @keyframes loader { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    /* Modal (kept minimal and without any default values) */
    .modal { display:none; position:fixed; z-index:1500; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:20px }
    .modal-content { background:#fff; border-radius:16px; max-width:420px; width:100%; padding:24px; box-shadow:var(--box-shadow) }
    .modal-buttons { display:flex; gap:12px; margin-top:10px }
  </style>
</head>
<body>
  <div class="container">
    <!-- Welcome Screen with Login/Signup -->
    <div class="welcome-screen" id="welcomeScreen">
      <h1>Secure File Backup Portal</h1>
      <p>Upload and store your files securely for later use. Sign up once and access your files anytime with your permanent Client ID.</p>

      <div class="auth-container">
        <div class="auth-tabs">
          <div class="auth-tab active" data-tab="login">Login</div>
          <div class="auth-tab" data-tab="signup">Sign Up</div>
        </div>

        <div class="auth-form active" id="loginForm">
          <div class="input-group">
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" placeholder="Enter your email" />
          </div>
          <div class="input-group">
            <label for="clientPassword">Password</label>
            <input type="password" id="clientPassword" placeholder="Enter your password" />
            <span class="password-toggle" id="clientPasswordToggle"><i class="fas fa-eye"></i></span>
          </div>
          <button class="btn btn-primary" id="clientLoginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>
        </div>

        <div class="auth-form" id="signupForm">
          <div class="input-group">
            <label for="signupName">Full Name</label>
            <input type="text" id="signupName" placeholder="Enter your full name" />
          </div>
          <div class="input-group">
            <label for="signupEmail">Email</label>
            <input type="email" id="signupEmail" placeholder="Enter your email" />
          </div>
          <div class="input-group">
            <label for="signupPassword">Password</label>
            <input type="password" id="signupPassword" placeholder="Create a password" />
            <span class="password-toggle" id="signupPasswordToggle"><i class="fas fa-eye"></i></span>
          </div>
          <button class="btn btn-primary" id="clientSignupBtn"><i class="fas fa-user-plus"></i> Sign Up</button>
        </div>
      </div>

      <p style="margin-top: 30px;">Or continue as a guest to try out the service</p>
      <button class="btn btn-outline" id="continueAsGuest" style="margin-top: 10px;"><i class="fas fa-user"></i> Continue as Guest</button>

      <div style="margin-top: 30px;">
        <button class="btn btn-outline" id="adminLoginBtn"><i class="fas fa-shield-alt"></i> Admin Login</button>
      </div>
    </div>

    <!-- Main Application Content -->
    <div class="app-content" id="appContent">
      <header>
        <div class="logo"><i class="fas fa-cloud-upload-alt"></i><span>SecureFileBackup</span></div>
        <div class="user-controls">
          <div class="admin-indicator" id="adminIndicator"><i class="fas fa-shield-alt"></i> Admin Mode</div>
          <div class="client-indicator" id="clientIndicator"><i class="fas fa-user"></i> Client Mode</div>
          <button class="btn btn-outline" id="loginButton"><i class="fas fa-sign-in-alt"></i> Admin Login</button>
          <button class="btn btn-outline" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
      </header>

      <div class="main-content">
        <h1>Secure File Backup Portal</h1>
        <p class="description">Upload and store your files securely for later use. Your files are associated with your permanent Client ID.</p>

        <div class="upload-container">
          <div class="drop-area" id="dropArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & Drop your files here</p>
            <p>or</p>
            <input type="file" class="file-input" id="fileInput" multiple />
            <button class="browse-btn">Browse Files</button>
          </div>

          <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
          <p class="status-message" id="statusMessage"></p>
        </div>

        <!-- Client Panel (always in DOM) -->
        <section class="panel" id="clientPanel">
          <h2>Your Uploaded Files</h2>
          <p class="description">All files you've uploaded are shown below. You can download or delete them as needed.</p>
          <div class="stats-container">
            <div class="stat-card"><i class="fas fa-database"></i><div class="number" id="clientTotalFiles">0</div><div class="label">Your Files</div></div>
            <div class="stat-card"><i class="fas fa-hdd"></i><div class="number" id="clientTotalStorage">0 MB</div><div class="label">Your Storage</div></div>
            <div class="stat-card"><i class="fas fa-id-card"></i><div class="label">Client ID</div><div class="number" id="clientIdDisplay">None</div></div>
          </div>
          <div class="files-grid" id="clientFilesGrid"></div>
        </section>

        <!-- Admin Panel is kept OUT of DOM until successful admin auth to prevent scraping -->
        <template id="adminPanelTemplate">
          <section class="panel" id="adminPanel">
            <h2>Admin File Management</h2>
            <p class="description">All files uploaded by clients are shown below. You can manage them from this panel.</p>
            <div class="stats-container">
              <div class="stat-card"><i class="fas fa-database"></i><div class="number" id="totalFiles">0</div><div class="label">Total Files</div></div>
              <div class="stat-card"><i class="fas fa-hdd"></i><div class="number" id="totalStorage">0 MB</div><div class="label">Total Storage</div></div>
              <div class="stat-card"><i class="fas fa-users"></i><div class="number" id="totalUsers">0</div><div class="label">Active Users</div></div>
            </div>
            <div class="tabs">
              <div class="tab active" data-tab="allFiles">All Files</div>
              <div class="tab" data-tab="clientFiles">By Client</div>
            </div>
            <div class="files-grid" id="filesGrid"></div>
          </section>
        </template>
      </div>

      <footer><p>© 2025 SecureFileBackup - All rights reserved | Secure cloud storage solution</p></footer>
    </div>

    <!-- Client ID Display Modal -->
    <div class="client-id-display" id="clientIdDisplayModal">
      <i class="fas fa-id-card" style="font-size: 40px; margin-bottom: 15px;"></i>
      <p>Your Client ID:</p>
      <div class="id-value" id="displayClientId"></div>
      <p>This ID is permanently assigned to you. Save it to access your files later!</p>
    </div>

    <!-- Admin Login Modal (no prefilled values, no hardcoded credentials) -->
    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h2><i class="fas fa-lock"></i> Admin Login</h2>
        <div class="input-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="Admin email" autocomplete="username" />
        </div>
        <div class="input-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Admin password" autocomplete="current-password" />
          <span class="password-toggle" id="passwordToggle"><i class="fas fa-eye"></i></span>
        </div>
        <div class="modal-buttons">
          <button class="btn btn-outline" id="cancelLogin">Cancel</button>
          <button class="btn btn-primary" id="submitLogin">Login</button>
        </div>
      </div>
    </div>

    <div class="notification" id="notification"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const welcomeScreen = document.getElementById('welcomeScreen');
      const appContent = document.getElementById('appContent');
      const dropArea = document.getElementById('dropArea');
      const fileInput = document.getElementById('fileInput');
      const browseBtn = dropArea.querySelector('.browse-btn');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const statusMessage = document.getElementById('statusMessage');
      const loginButton = document.getElementById('loginButton');
      const logoutButton = document.getElementById('logoutButton');
      const loginModal = document.getElementById('loginModal');
      const cancelLogin = document.getElementById('cancelLogin');
      const submitLogin = document.getElementById('submitLogin');
      const adminIndicator = document.getElementById('adminIndicator');
      const clientIndicator = document.getElementById('clientIndicator');
      const clientPanel = document.getElementById('clientPanel');
      const clientFilesGrid = document.getElementById('clientFilesGrid');
      const clientTotalFiles = document.getElementById('clientTotalFiles');
      const clientTotalStorage = document.getElementById('clientTotalStorage');
      const clientIdDisplay = document.getElementById('clientIdDisplay');
      const notification = document.getElementById('notification');
      const clientIdDisplayModal = document.getElementById('clientIdDisplayModal');
      const displayClientId = document.getElementById('displayClientId');
      const passwordToggle = document.getElementById('passwordToggle');
      const passwordInput = document.getElementById('password');
      const authTabs = document.querySelectorAll('.auth-tab');
      const authForms = document.querySelectorAll('.auth-form');
      const clientLoginBtn = document.getElementById('clientLoginBtn');
      const clientSignupBtn = document.getElementById('clientSignupBtn');
      const clientPasswordToggle = document.getElementById('clientPasswordToggle');
      const clientPasswordInput = document.getElementById('clientPassword');
      const signupPasswordToggle = document.getElementById('signupPasswordToggle');
      const signupPasswordInput = document.getElementById('signupPassword');
      const continueAsGuest = document.getElementById('continueAsGuest');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      const adminPanelTemplate = document.getElementById('adminPanelTemplate');

      // State
      let selectedFiles = [];
      let isAdmin = sessionStorage.getItem('isAdmin') === 'true';
      let currentClientId = localStorage.getItem('currentClientId') || '';
      let files = JSON.parse(localStorage.getItem('files')) || [];
      let clients = JSON.parse(localStorage.getItem('clients')) || {};
      let users = JSON.parse(localStorage.getItem('users')) || {};

      // Rate limiting for admin login (basic, client-side)
      const RATE_LIMIT_KEY = 'admin_login_attempts';
      const LOCK_UNTIL_KEY = 'admin_lock_until';
      const MAX_ATTEMPTS = 5;
      const LOCK_MINUTES = 15;

      // If already logged in as client
      if (currentClientId) { showApp(); autoLoginClient(currentClientId); }
      if (isAdmin) { showApp(); elevateToAdmin(); }

      function showApp(){ welcomeScreen.style.display='none'; appContent.style.display='block'; }
      function showWelcome(){ welcomeScreen.style.display='flex'; appContent.style.display='none'; }

      // Password toggles
      passwordToggle.addEventListener('click', () => toggleInputVisibility(passwordInput, passwordToggle));
      clientPasswordToggle.addEventListener('click', () => toggleInputVisibility(clientPasswordInput, clientPasswordToggle));
      signupPasswordToggle.addEventListener('click', () => toggleInputVisibility(signupPasswordInput, signupPasswordToggle));
      function toggleInputVisibility(input, toggleEl){
        if(input.type === 'password'){ input.type='text'; toggleEl.innerHTML='<i class="fas fa-eye-slash"></i>'; }
        else { input.type='password'; toggleEl.innerHTML='<i class="fas fa-eye"></i>'; }
      }

      // Auth tabs
      authTabs.forEach(tab => tab.addEventListener('click', () => {
        const name = tab.dataset.tab;
        authTabs.forEach(t => t.classList.remove('active')); tab.classList.add('active');
        authForms.forEach(f => f.classList.remove('active'));
        document.getElementById(`${name}Form`).classList.add('active');
      }));

      // Continue as guest
      continueAsGuest.addEventListener('click', () => {
        currentClientId = generateClientId();
        localStorage.setItem('currentClientId', currentClientId);
        if (!clients[currentClientId]) { clients[currentClientId] = []; localStorage.setItem('clients', JSON.stringify(clients)); }
        showApp(); showClientId(currentClientId);
        clientPanel.style.display='block'; clientIndicator.style.display='flex'; clientIndicator.innerHTML = `<i class="fas fa-user"></i> Guest: ${currentClientId}`;
        updateClientStats();
        showNotification('Welcome! You are using a guest account. Sign up to make it permanent.','success');
      });

      // Admin login buttons
      adminLoginBtn.addEventListener('click', () => loginModal.style.display='flex');
      loginButton.addEventListener('click', () => {
        if (isAdmin) { // admin logout (session-only)
          sessionStorage.removeItem('isAdmin');
          isAdmin = false;
          removeAdminPanel();
          adminIndicator.style.display='none';
          loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Admin Login';
          showNotification('Admin logout successful','success');
        } else { loginModal.style.display='flex'; }
      });
      cancelLogin.addEventListener('click', () => loginModal.style.display='none');

      // Secure (client-side) admin auth: compares SHA-256(password) to data-admin-hash on <html>
      // Also allows specific credentials: zeeshankhan951789@gmail.com / nonono
      submitLogin.addEventListener('click', async () => {
        // Rate limit check
        const now = Date.now();
        const lockUntil = parseInt(sessionStorage.getItem(LOCK_UNTIL_KEY) || '0', 10);
        if (now < lockUntil) {
          const seconds = Math.ceil((lockUntil - now)/1000);
          showNotification(`Too many attempts. Try again in ${seconds}s.`,'error');
          return;
        }

        const email = (document.getElementById('email').value || '').trim();
        const password = document.getElementById('password').value || '';
        if (!email || !password) { showNotification('Enter email and password','error'); return; }

        try {
          // Check for specific credentials first
          if (email === 'zeeshankhan951789@gmail.com' && password === 'nonono') {
            // Success for specific credentials
            sessionStorage.setItem('isAdmin','true');
            isAdmin = true;
            resetRateLimit();
            loginModal.style.display='none';
            elevateToAdmin();
            showNotification('Admin access granted','success');
            return;
          }

          // Then check hash-based authentication
          const adminHash = (document.documentElement.getAttribute('data-admin-hash') || '').toLowerCase();
          if (!adminHash) { showNotification('Admin is not configured. Set data-admin-hash on <html>.','error'); return; }
          const inputHash = await sha256Hex(password);

          if (timingSafeEqual(adminHash, inputHash)) {
            // success
            sessionStorage.setItem('isAdmin','true');
            isAdmin = true;
            resetRateLimit();
            loginModal.style.display='none';
            elevateToAdmin();
            showNotification('Admin access granted','success');
          } else {
            registerFailedAttempt();
            showNotification('Invalid credentials. Please try again.','error');
          }
        } catch (e) {
          showNotification('Auth error. Please retry.','error');
        }
      });

      function elevateToAdmin(){
        // Insert admin panel into DOM only after successful auth
        if (!document.getElementById('adminPanel')) {
          const frag = adminPanelTemplate.content.cloneNode(true);
          document.querySelector('.main-content').appendChild(frag);
          // Now that the panel exists, render data
          renderFiles();
          updateStats();
          // Tab wiring
          document.querySelectorAll('#adminPanel .tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document.querySelectorAll('#adminPanel .tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              renderFiles();
            });
          });
        }
        adminIndicator.style.display='flex';
        loginButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
        document.getElementById('adminPanel').style.display='block';
      }

      function removeAdminPanel(){
        const panel = document.getElementById('adminPanel');
        if (panel) panel.remove();
      }

      // Client signup
      clientSignupBtn.addEventListener('click', () => {
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        if (!name || !email || !password) { showNotification('Please fill all fields','error'); return; }
        if (users[email]) { showNotification('Email already registered. Please login instead.','error'); return; }
        const clientId = generateClientId();
        users[email] = { name, email, password, clientId, signupDate: new Date().toLocaleDateString() };
        if (!clients[clientId]) clients[clientId] = [];
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('clients', JSON.stringify(clients));
        localStorage.setItem('currentClientId', clientId);
        currentClientId = clientId;
        showNotification('Account created successfully!','success');
        showClientId(clientId);
        showApp();
        autoLoginClient(clientId);
      });

      // Client login
      clientLoginBtn.addEventListener('click', () => {
        const email = document.getElementById('clientEmail').value.trim();
        const password = document.getElementById('clientPassword').value;
        if (!email || !password) { showNotification('Please enter email and password','error'); return; }
        if (!users[email]) { showNotification('No account found with this email','error'); return; }
        if (users[email].password !== password) { showNotification('Incorrect password','error'); return; }
        const clientId = users[email].clientId;
        localStorage.setItem('currentClientId', clientId);
        currentClientId = clientId;
        showNotification('Login successful!','success');
        showApp();
        autoLoginClient(clientId);
      });

      // Auto client mode
      function autoLoginClient(clientId){
        clientPanel.style.display='block';
        clientIndicator.style.display='flex';
        clientIndicator.innerHTML = `<i class=\"fas fa-user\"></i> Client: ${clientId}`;
        logoutButton.style.display='block';
        renderClientFiles();
        updateClientStats();
      }

      // Logout clears both roles (admin session is session-only)
      logoutButton.addEventListener('click', () => {
        localStorage.removeItem('currentClientId');
        sessionStorage.removeItem('isAdmin');
        currentClientId=''; isAdmin=false;
        removeAdminPanel();
        clientPanel.style.display='none';
        adminIndicator.style.display='none';
        clientIndicator.style.display='none';
        logoutButton.style.display='none';
        showWelcome();
        showNotification('Logged out successfully','success');
      });

      // Drag & drop
      ['dragenter','dragover','dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, preventDefaults, false));
      function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
      ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, () => dropArea.style.backgroundColor = '#e6f2ff', false));
      ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, () => dropArea.style.backgroundColor = '', false));
      dropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files), false);
      browseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => handleFiles(fileInput.files));

      function handleFiles(fileList){
        selectedFiles = Array.from(fileList);
        if (!selectedFiles.length) return;
        if (!currentClientId){
          currentClientId = generateClientId();
          localStorage.setItem('currentClientId', currentClientId);
          if (!clients[currentClientId]) { clients[currentClientId] = []; localStorage.setItem('clients', JSON.stringify(clients)); }
          clientPanel.style.display='block';
          clientIndicator.style.display='flex';
          clientIndicator.innerHTML = `<i class=\"fas fa-user\"></i> Guest: ${currentClientId}`;
          showNotification(`Using temporary Client ID: ${currentClientId}. Sign up to make it permanent.`, 'success');
        }
        statusMessage.textContent = `Uploading ${selectedFiles.length} file(s)...`;
        uploadFiles();
      }

      function uploadFiles(){
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        let width = 0; const interval = setInterval(() => { width += 5; progressBar.style.width = width + '%'; if (width >= 100) { clearInterval(interval); finalizeUpload(); } }, 100);
      }

      function finalizeUpload(){
        selectedFiles.forEach(file => {
          const fileData = {
            id: Date.now() + Math.random().toString(36).substr(2,9),
            name: file.name,
            size: formatFileSize(file.size),
            type: file.type,
            uploadDate: new Date().toLocaleDateString(),
            clientId: currentClientId,
            url: URL.createObjectURL(file)
          };
          files.push(fileData);
          if (!clients[currentClientId]) clients[currentClientId] = [];
          clients[currentClientId].push(fileData.id);
        });
        localStorage.setItem('files', JSON.stringify(files));
        localStorage.setItem('clients', JSON.stringify(clients));
        statusMessage.textContent = 'Upload completed successfully!';
        showNotification('Files uploaded successfully!','success');
        if (isAdmin) { renderFiles(); updateStats(); }
        if (currentClientId) { renderClientFiles(); updateClientStats(); }
        setTimeout(() => { progressContainer.style.display='none'; statusMessage.textContent=''; selectedFiles = []; }, 3000);
      }

      function showClientId(clientId){ displayClientId.textContent = clientId; clientIdDisplayModal.style.display = 'block'; setTimeout(() => { clientIdDisplayModal.style.display = 'none'; }, 10000); }
      function generateClientId(){ return 'CLI-' + Math.random().toString(36).substr(2,9).toUpperCase(); }
      function formatFileSize(bytes){ if(bytes===0) return '0 Bytes'; const k=1024; const sizes=['Bytes','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i]; }

      function renderFiles(){
        const filesGrid = document.getElementById('filesGrid');
        if (!filesGrid) return;
        const tab = document.querySelector('#adminPanel .tab.active').dataset.tab;
        let filteredFiles = [];
        if (tab === 'allFiles') filteredFiles = files;
        else if (tab === 'clientFiles') filteredFiles = files; // Grouping by client would be more complex
        filesGrid.innerHTML = filteredFiles.length ? filteredFiles.map(file => `
          <div class="file-card">
            <div class="file-preview"><i class="fas fa-file"></i></div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-meta"><span>${file.size}</span><span>${file.uploadDate}</span></div>
              <div class="file-meta"><span>Client: ${file.clientId}</span></div>
              <div class="file-actions">
                <button class="action-btn download-btn" data-id="${file.id}"><i class="fas fa-download"></i> Download</button>
                <button class="action-btn delete-btn" data-id="${file.id}"><i class="fas fa-trash"></i> Delete</button>
              </div>
            </div>
          </div>
        `).join('') : '<p style="grid-column:1/-1; text-align:center; color:var(--gray);">No files found</p>';
        // Attach event listeners
        filesGrid.querySelectorAll('.download-btn').forEach(btn => btn.addEventListener('click', e => downloadFile(e.target.dataset.id)));
        filesGrid.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteFile(e.target.dataset.id)));
      }

      function renderClientFiles(){
        const clientFiles = files.filter(f => f.clientId === currentClientId);
        clientFilesGrid.innerHTML = clientFiles.length ? clientFiles.map(file => `
          <div class="file-card">
            <div class="file-preview"><i class="fas fa-file"></i></div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-meta"><span>${file.size}</span><span>${file.uploadDate}</span></div>
              <div class="file-actions">
                <button class="action-btn download-btn" data-id="${file.id}"><i class="fas fa-download"></i> Download</button>
                <button class="action-btn delete-btn" data-id="${file.id}"><i class="fas fa-trash"></i> Delete</button>
              </div>
            </div>
          </div>
        `).join('') : '<p style="grid-column:1/-1; text-align:center; color:var(--gray);">No files uploaded yet</p>';
        // Attach event listeners
        clientFilesGrid.querySelectorAll('.download-btn').forEach(btn => btn.addEventListener('click', e => downloadFile(e.target.dataset.id)));
        clientFilesGrid.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteFile(e.target.dataset.id)));
      }

      function downloadFile(id){
        const file = files.find(f => f.id === id);
        if (!file) return;
        const a = document.createElement('a');
        a.href = file.url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showNotification(`Downloading ${file.name}`,'success');
      }

      function deleteFile(id){
        const file = files.find(f => f.id === id);
        if (!file) return;
        if (!confirm(`Are you sure you want to delete ${file.name}?`)) return;
        files = files.filter(f => f.id !== id);
        if (clients[file.clientId]) clients[file.clientId] = clients[file.clientId].filter(fid => fid !== id);
        localStorage.setItem('files', JSON.stringify(files));
        localStorage.setItem('clients', JSON.stringify(clients));
        if (isAdmin) { renderFiles(); updateStats(); }
        if (currentClientId) { renderClientFiles(); updateClientStats(); }
        showNotification(`Deleted ${file.name}`,'success');
      }

      function updateStats(){
        const totalFiles = document.getElementById('totalFiles');
        const totalStorage = document.getElementById('totalStorage');
        const totalUsers = document.getElementById('totalUsers');
        if (!totalFiles || !totalStorage || !totalUsers) return;
        totalFiles.textContent = files.length;
        const totalBytes = files.reduce((acc, file) => acc + parseFloat(file.size), 0);
        totalStorage.textContent = formatFileSize(totalBytes);
        totalUsers.textContent = Object.keys(clients).length;
      }

      function updateClientStats(){
        const clientFiles = files.filter(f => f.clientId === currentClientId);
        clientTotalFiles.textContent = clientFiles.length;
        const totalBytes = clientFiles.reduce((acc, file) => acc + parseFloat(file.size), 0);
        clientTotalStorage.textContent = formatFileSize(totalBytes);
        clientIdDisplay.textContent = currentClientId;
      }

      function showNotification(message, type = 'success'){
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
      }

      // Utility: SHA-256 (for secure password hashing)
      async function sha256Hex(message) {
        const encoder = new TextEncoder();
        const data = encoder.encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      // Utility: Timing-safe string comparison
      function timingSafeEqual(a, b) {
        const aBuff = new TextEncoder().encode(a);
        const bBuff = new TextEncoder().encode(b);
        if (aBuff.length !== bBuff.length) return false;
        let result = 0;
        for (let i = 0; i < aBuff.length; i++) result |= aBuff[i] ^ bBuff[i];
        return result === 0;
      }

      // Rate limiting for admin login
      function registerFailedAttempt() {
        const attempts = parseInt(sessionStorage.getItem(RATE_LIMIT_KEY) || '0', 10) + 1;
        sessionStorage.setItem(RATE_LIMIT_KEY, attempts.toString());
        if (attempts >= MAX_ATTEMPTS) {
          const lockUntil = Date.now() + (LOCK_MINUTES * 60 * 1000);
          sessionStorage.setItem(LOCK_UNTIL_KEY, lockUntil.toString());
          showNotification(`Too many failed attempts. Locked for ${LOCK_MINUTES} minutes.`,'error');
        }
      }

      function resetRateLimit() {
        sessionStorage.removeItem(RATE_LIMIT_KEY);
        sessionStorage.removeItem(LOCK_UNTIL_KEY);
      }
    });
  </script>
</body>
</html>